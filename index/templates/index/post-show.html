{% extends 'index/base.html' %}
{% load static %}
{% load staticfiles %}

{% block header %}
    <style type="text/css">
        .commentquote {
            font-style: oblique;
            background: #DDDDDD;
            border: 1px dotted
        }

        a.likecomment {
            text-decoration: none
        }


    </style>
    <link rel="stylesheet" href="/static/assets/css/ace.min.front.css"/>

    <script type="text/javascript" src="{% static 'tinymce/tinymce.min.js' %}"></script>
    {#    <script type="text/javascript">#}
    {#        tinymce.init({#}
    {#            selector: "textarea",#}
    {#width: 800,#}
    {#            height: 300,#}
    {#            forced_root_block: false,#}
    {#            convert_urls: false,#}
    {#            imageupload_url: '{% url 'upload' %}',#}
    {#            plugins: [],#}
    {#            toolbar: "styleselect | bold italic | alignleft aligncenter" +#}
    {#            " alignright alignjustify | bullist numlist outdent indent |  link image"#}
    {#        });#}
    {#    </script>#}
    <script type="text/javascript" src="{% static 'tinymce/plugins/jquery-form.js' %}"></script>
    <script type="text/javascript">
        $.ajaxSetup({headers: {"X-CSRFToken": '{{ csrf_token }}'}});
    </script>
{% endblock %}

{% block page %}
    <div class="col-md-8 ">
        <div class="blog-post">
            <h1>{{ post.title }}.</h1>
            <h4><i class="icon-user"></i> <a href="#">{{ post.pub_author }}</a> <i
                    class="icon-calendar"></i> {{ post.pub_date }}
                <i class="icon-folder-open"></i> <a href="#"> {% if post.category is None %}未分类{% else %}
                    {{ post.category }}{% endif %}</a>
                <i class="icon-eye-open"></i> {{ post.view_count }}
            {% if post.comment_count == 0 %}
                <i class="icon-comment-alt"></i> <span id="comment_count">{{ post.comment_count }}</span>
            {% else %}
                <i class="icon-comment"></i> <span id="comment_count">{{ post.comment_count }}</span>
            {% endif %}
                {#            {% print request.session.user %}#}
                {% load likearticleship_tags %}
                {% if request.session.user.pk not in post.likearticleship_set.all|pk_list %}
                    <a href="javascript:void (0);" id="{{ post.pk }}" class="likearticle"> <i
                            class="icon-heart-empty"></i></a> <span id="like_count">{{ post.like_count }}</span>
            {% else %}
                    <a href="javascript:void (0);" id="{{ post.pk }}" class="likearticle"> <i
                            class="icon-heart red"></i> </a>
                <span id="like_count">{{ post.like_count }}</span>
            {% endif %}
            </h4>

            <p style=word-wrap:break-word;>
                {{ post.content|safe }}
            </p>
            <h3><i class="icon-tags"></i> ：{% for tag in post.tag_set.all %}
                <label class="label-info label-lg label">{{ tag }}</label>
            {% endfor %}
            </h3>
            <div class="col-md-6 text-left">
                {% if pre_post %}
                    <a href="{{ pre_post.guid }}">
                        <span aria-hidden="true"><< {{ pre_post }}</span>
                    </a>
                {% endif %}
            </div>


            <div class="col-md-6 text-right">
                {% if next_post %}
                    <a href="{{ next_post.guid }}">
                        <span aria-hidden="true">{{ next_post }} >></span>
                    </a>
                {% endif %}
            </div>

        </div>
        <div class="space"></div>


        {#        <div class="col-md-12 blog-post">#}
        {#            <div class="col-md-6 text-left align-center">#}
        {#                {% if pre_post %}#}
        {#                    <a href="{{ pre_post.guid }}">#}
        {#                        <span aria-hidden="true"><< {{ pre_post }}</span>#}
        {#                    </a>#}
        {#                {% endif %}#}
        {#            </div>#}
        {##}
        {##}
        {#            <div class="col-md-6 text-right align-center">#}
        {#                {% if next_post %}#}
        {#                    <a href="{{ next_post.guid }}">#}
        {#                        <span aria-hidden="true">{{ next_post }} >></span>#}
        {#                    </a>#}
        {#                {% endif %}#}
        {#            </div>#}
        {##}
        {#        </div>#}


        <div class="col-md-12">
            <div class="widget-box transparent" id="recent-box">
                {% if post.comment_status == '1'  %}
                <div class="widget-header">
                    <h4 class="lighter smaller">
                        <i class="icon-rss orange"></i>
                        最近
                    </h4>

                    <div class="widget-toolbar no-border">
                        <ul class="nav nav-tabs" id="recent-tab">


                            <li class="active">
                                <a data-toggle="tab" href="#comment-tab">评论</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="widget-body">
                    <div class="widget-main padding-4">
                        <div class="tab-content padding-8 overflow-visible">


                            <div id="comment-tab" class="tab-pane active">

                                <div class="comments" id="comments">

                                    {% for comment in comments %}
                                        <div class="itemdiv commentdiv">
                                            <div class="user">
                                                {% if comment.user %}
                                                    <img alt="{{ comment.comment_author }}'s Avatar"
                                                         src="{{ comment.user.avatar }}"/>
                                                {% else %}
                                                    <img alt="{{ comment.comment_author }}'s Avatar"
                                                         src="/static/assets/avatars/avatar.png"/>
                                                {% endif %}
                                            </div>

                                            <div class="body">
                                                <div class="name">
                                                    <a href="#">{{ comment.comment_author }}</a>
                                                </div>

                                                <div class="time">
                                                    {% if request.session.user.pk not in comment.likecommentship_set.all|pk_list %}
                                                     <a href="javascript:void(0);" id="{{ comment.pk }}" class="likecomment"> <i class="icon-thumbs-up-alt"></i></a>
                                                    <span id="like_comment_count">{{ comment.likecommentship_set.all.count }}</span>
                                                    {% else %}
                                                        <a href="javascript:void(0);" id="{{ comment.pk }}" class="likecomment"> <i class="icon-thumbs-up red"></i></a>
                                                        <span id="like_comment_count">{{ comment.likecommentship_set.all.count }}</span>
                                                    {% endif %}
                                                    <i class="icon-time"></i>
                                                    <span class="blue">{{ comment.comment_date }}</span>
                                                </div>

                                                <div class="text">
                                                    <div class="space"></div>
                                                    {% if comment.parent %}
                                                        <div class="commentquote">
                                                            <div class="name col-md-6 no-padding-left">
                                                                @{{ comment.parent.comment_author }}
                                                            </div>
                                                            <div class="time col-md-6 text-right">
                                                                <i class="icon-time"></i>
                                                                <span class="blue">{{ comment.parent.comment_date }}</span>
                                                            </div>
                                                            <div class="text">
                                                                <i class="icon-quote-left"></i>{{ comment.parent.comment }}
                                                            </div>
                                                        </div>
                                                        <div class="space"></div>
                                                    {% endif %}
                                                    {#                                                <i class="icon-quote-left"></i>#}
                                                    {{ comment.comment|safe }}
                                                    <div class="space"></div>
                                                </div>


                                            </div>
                                            <div class="tools">
                                                <div class="action-buttons bigger-125">
                                                    <a href="javascript:void(0);" id="{{ comment.pk }}" class="comment">
                                                        <i class="icon-comments blue"></i>
                                                    </a>
                                                    {% if request.session.user.username == comment.comment_author or request.session.user.is_superuser %}
                                                        <a href="javascript:void(0);" id="{{ comment.pk }}"
                                                           class="comment_del">
                                                        <i class="icon-trash red"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>

                                            </div>


                                        </div>
                                    {% endfor %}

                                </div>

                                <div class="hr hr8" id="commenthr"></div>

                                <div class="col-md-12" id="divcomment">
                                    <div class="center">
                                        <i class="icon-comments-alt icon-2x green"></i>

                                        &nbsp;<label class="control-label no-padding-left"
                                                     for="form-field-textarea">发表评论</label>
                                    </div>

                                    <form class="form-horizontal" role="form" id="commentForm"
                                          action="{% url 'comment' %}"
                                          method="post">
                                        {% csrf_token %}
                                        {% if not request.session.user %}
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right"
                                                       for="form-field-1"> 姓名：</label>

                                                <div class="col-sm-11">
                                                    <input type="text" id="form-field-1" name="comment_author"
                                                           placeholder="comment_author"
                                                           class="col-xs-10 col-sm-5 align-left"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right"
                                                       for="form-field-2"> 邮箱：</label>

                                                <div class="col-sm-11">
                                                    <input type="text" id="form-field-2" name="comment_author_email"
                                                           placeholder="comment_author_email"
                                                           class="col-xs-10 col-sm-5 align-left"/>
                                                </div>
                                            </div>
                                        {% else %}
                                            <input type="hidden" name="user" value="{{ request.session.user.pk }}">
                                            <input type="hidden" name="comment_author"
                                                   value="{{ request.session.user.username }}">
                                            <input type="hidden" name="comment_author_email"
                                                   value="{{ request.session.user.email }}">
                                        {% endif %}
                                        <textarea id="form-field-textarea" name="comment" class="form-control" rows="5"
                                                  value=""></textarea>
                                        <input type="hidden" name="article" value="{{ post.pk }}">
                                        <input type="hidden" name="comment_author_ip" value="
                                    {% if not request.META.HTTP_X_FORWARDED_FOR %}
                                        {{ request.META.REMOTE_ADDR }}
                                    {% else %}
                                        {{ request.META.HTTP_X_FORWARDED_FOR }}
                                    {% endif %}
                                    ">

                                        <div class="space"></div>
                                        <div class="form-group" id="submitcomment">
                                            <button class="btn btn-sm btn-danger" type="button" id="subcomm">
                                                <i class="icon-ok bigger-110"></i>
                                                发表评论
                                            </button>
                                        </div>
                                    </form>

                                    <div class="space"></div>

                                </div>

                                <div class="hr hr-double hr8"></div>
                            </div>
                        </div>
                    </div><!-- /widget-main -->
                </div><!-- /widget-body -->
                {% elif post.comment_status == '2' %}
                     <div class="widget-header">
                    <h4 class="lighter smaller">
                        <i class="icon-rss orange"></i>
                        最近
                    </h4>

                    <div class="widget-toolbar no-border">
                        <ul class="nav nav-tabs" id="recent-tab">


                            <li class="active">
                                <a data-toggle="tab" href="#comment-tab">评论关闭</a>
                            </li>
                        </ul>
                    </div>
                         <div class="space"></div>
                </div>
                {% endif %}
            </div><!-- /widget-box -->
        </div><!-- /span -->
    </div>
    <div class="col-md-1"></div>
    {#    <script type="text/javascript" src="{% static 'tinymce/plugins/jquery-form.js' %}"></script>#}

    <script
            type="text/javascript">
        $(document).ready(function () {
            $("#form-field-textarea").click(function () {
                tinymce.init({
                    selector: "textarea",
                    {#width: 800,#}
                    height: 100,
                    forced_root_block: false,
                    convert_urls: false,
                    {#            imageupload_url: '{% url 'upload' %}',#}
                    plugins: [],
                    toolbar: "styleselect | bold italic | alignleft aligncenter" +
                    " alignright alignjustify | bullist numlist outdent indent |  link image"
                });

            })

            $("div#comment-tab").on("click", ".comment", function () {
                obj = $(this).parent().parent().prev().children('div.text');
                {#                alert(obj.prop("class"));#}
                tinymce.remove();
                $("textarea").remove();
                $("form").remove();
                $("#divcomment").remove();
                parent = $(this).attr("id");
                {#                alert(parent);#}
                html = "<div  id='divcomment'>\n" +
                    "                                    <div class=\"center\">\n" +
                    "                                        <i class=\"icon-comments-alt icon-2x green\"></i>\n" +
                    "\n" +
                    "                                        &nbsp;<label class=\"control-label no-padding-left\"\n" +
                    "                                                     for=\"form-field-textarea\">发表评论</label>\n" +
                    "                                    </div>\n" +
                    "\n" +
                    "                                    <form class=\"form-horizontal\" role=\"form\" id=\"commentForm\"\n" +
                    "                                          action=\"{% url 'comment' %}\"\n" +
                    "                                          method=\"post\">\n" +
                    "                                        {% csrf_token %}\n" +
                    "                                        {% if not request.session.user %}\n"+
                        "                                            <div class=\"form-group\">\n"+
                        "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                        +
                        "                                                       for=\"form-field-1\"> 姓名：</label>\n"+
                        "\n"+
                        "                                                <div class=\"col-sm-10\">\n"+
                        "                                                    <input type=\"text\" id=\"form-field-1\" name=\"comment_author\"\n"
                        +
                        "                                                           placeholder=\"comment_author\"\n"+
                        "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                        +
                        "                                                </div>\n"+
                        "                                            </div>\n"+
                        "                                            <div class=\"form-group\">\n"+
                        "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                        +
                        "                                                       for=\"form-field-2\"> 邮箱：</label>\n"+
                        "\n"+
                        "                                                <div class=\"col-sm-10\">\n"+
                        "                                                    <input type=\"text\" id=\"form-field-2\" name=\"comment_author_email\"\n"
                        +
                        "                                                           placeholder=\"comment_author_email\"\n"
                        +
                        "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                        +
                        "                                                </div>\n"+
                        "                                            </div>\n"+
                        "                                        {% else %}\n"+
                        "                                            <input type=\"hidden\" name=\"user\" value=\"{{ request.session.user.pk }}\">\n"
                        +
                        "                                            <input type=\"hidden\" name=\"comment_author\"\n"+
                        "                                                   value=\"{{ request.session.user.username }}\">\n"
                        +
                        "                                            <input type=\"hidden\" name=\"comment_author_email\"\n"
                        +
                        "                                                   value=\"{{ request.session.user.email }}\">\n"
                        +
                        "                                        {% endif %}\n" +
                    "                                        <textarea id=\"form-field-textarea\" name=\"comment\" class=\"form-control\" rows=\"5\"\n" +
                    "                                                  value=\"\"></textarea>\n" +
                    "                                        <input type=\"hidden\" name=\"article\" value=\"{{ post.pk }}\">\n" +
                    "                                        <input type=\"hidden\" name=\"parent\" value=\" " + parent + "\">\n" +
                    "                                        <input type=\"hidden\" name=\"comment_author_ip\" value=\"\n" +
                    "                                    {% if not request.META.HTTP_X_FORWARDED_FOR %}\n"+
                        "                                        {{ request.META.REMOTE_ADDR }}\n"+
                        "                                    {% else %}\n"+
                        "                                        {{ request.META.HTTP_X_FORWARDED_FOR }}\n"+
                        "                                    {% endif %}\n" +
                    "                                    \">\n" +
                    "\n" +
                    "                                        <div class=\"space\"></div>\n" +
                    "                                        <div class=\"form-group\" id=\"submitdiv\">\n" +
                    "                                            <button class=\"btn btn-sm btn-danger\" type=\"button\" id=\"submit\">\n" +
                    "                                                <i class=\"icon-ok bigger-110\"></i>\n" +
                    "                                                发表评论\n" +
                    "                                            </button>\n" +
                    "                                            <button class=\"btn btn-sm btn-danger\" type=\"button\" id=\"cancel\">\n" +
                    "                                                <i class=\"icon-ok bigger-110\"></i>\n" +
                    "                                                取消评论\n" +
                    "                                            </button>\n" +
                    "                                        </div>\n" +
                    "                                    </form>\n" +
                    "\n" +
                    "                                    <div class=\"space\"></div>\n" +
                    "\n" +
                    "                                </div>"
                {#                obj.append("<textarea id=\"form-field-textarea\" name=\"comment\" class=\"form-control\" rows=\"5\" value=\"\"></textarea><div class=\"space\"></div>");#}
                obj.append(html)
                tinymce.init({
                    selector: "textarea",
                    {#width: 800,#}
                    height: 100,
                    forced_root_block: false,
                    convert_urls: false,
                    {#            imageupload_url: '{% url 'upload' %}',#}
                    plugins: ["save"],
                    toolbar: "save styleselect | bold italic | alignleft aligncenter" +
                    " alignright alignjustify | bullist numlist outdent indent |  link image"
                });
            })

            $("div#comment-tab").on('click', '#cancel', function () {
                tinymce.remove();
                $("textarea").remove();
                $("form").remove();
                $("#divcomment").remove();
                html = "<div  id='divcomment'>\n" +
                    "                                    <div class=\"center\">\n" +
                    "                                        <i class=\"icon-comments-alt icon-2x green\"></i>\n" +
                    "\n" +
                    "                                        &nbsp;<label class=\"control-label no-padding-left\"\n" +
                    "                                                     for=\"form-field-textarea\">发表评论</label>\n" +
                    "                                    </div>\n" +
                    "\n" +
                    "                                    <form class=\"form-horizontal\" role=\"form\" id=\"commentForm\"\n" +
                    "                                          action=\"{% url 'comment' %}\"\n" +
                    "                                          method=\"post\">\n" +
                    "                                        {% csrf_token %}\n" +
                    "                                        {% if not request.session.user %}\n"+
                        "                                            <div class=\"form-group\">\n"+
                        "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                        +
                        "                                                       for=\"form-field-1\"> 姓名：</label>\n"+
                        "\n"+
                        "                                                <div class=\"col-sm-10\">\n"+
                        "                                                    <input type=\"text\" id=\"form-field-1\" name=\"comment_author\"\n"
                        +
                        "                                                           placeholder=\"comment_author\"\n"+
                        "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                        +
                        "                                                </div>\n"+
                        "                                            </div>\n"+
                        "                                            <div class=\"form-group\">\n"+
                        "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                        +
                        "                                                       for=\"form-field-2\"> 邮箱：</label>\n"+
                        "\n"+
                        "                                                <div class=\"col-sm-10\">\n"+
                        "                                                    <input type=\"text\" id=\"form-field-2\" name=\"comment_author_email\"\n"
                        +
                        "                                                           placeholder=\"comment_author_email\"\n"
                        +
                        "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                        +
                        "                                                </div>\n"+
                        "                                            </div>\n"+
                        "                                        {% else %}\n"+
                        "                                            <input type=\"hidden\" name=\"user\" value=\"{{ request.session.user.pk }}\">\n"
                        +
                        "                                            <input type=\"hidden\" name=\"comment_author\"\n"+
                        "                                                   value=\"{{ request.session.user.username }}\">\n"
                        +
                        "                                            <input type=\"hidden\" name=\"comment_author_email\"\n"
                        +
                        "                                                   value=\"{{ request.session.user.email }}\">\n"
                        +
                        "                                        {% endif %}\n" +
                    "                                        <textarea id=\"form-field-textarea\" name=\"comment\" class=\"form-control\" rows=\"5\"\n" +
                    "                                                  value=\"\"></textarea>\n" +
                    "                                        <input type=\"hidden\" name=\"article\" value=\"{{ post.pk }}\">\n" +

                    "                                        <input type=\"hidden\" name=\"comment_author_ip\" value=\"\n" +
                    "                                    {% if not request.META.HTTP_X_FORWARDED_FOR %}\n"+
                        "                                        {{ request.META.REMOTE_ADDR }}\n"+
                        "                                    {% else %}\n"+
                        "                                        {{ request.META.HTTP_X_FORWARDED_FOR }}\n"+
                        "                                    {% endif %}\n" +
                    "                                    \">\n" +
                    "\n" +
                    "                                        <div class=\"space\"></div>\n" +
                    "                                        <div class=\"form-group\" id=\"submitcomment\">\n" +
                    "                                            <button class=\"btn btn-sm btn-danger\" type=\"button\" id=\"subcomm2\">\n" +
                    "                                                <i class=\"icon-ok bigger-110\"></i>\n" +
                    "                                                发表评论\n" +
                    "                                            </button>\n" +

                    "                                        </div>\n" +
                    "                                    </form>\n" +
                    "\n" +
                    "                                    <div class=\"space\"></div>\n" +
                    "\n" +
                    "                                </div>"
                obj = $('div#commenthr')

                obj.after(html);
                tinymce.init({
                    selector: "textarea",
                    {#width: 800,#}
                    height: 100,
                    forced_root_block: false,
                    convert_urls: false,
                    {#            imageupload_url: '{% url 'upload' %}',#}
                    plugins: ["save"],
                    toolbar: "save styleselect | bold italic | alignleft aligncenter" +
                    " alignright alignjustify | bullist numlist outdent indent |  link image"
                });

            })

            $("div#divcomment").on('click', '#subcomm', function () {
                var tagUrl = $("#commentForm").attr("action");
                {#                var veto = {};#}
                {##}
                {#                $('#commentForm').ajaxForm();#}
                {#                $('#commentForm').bind('form-pre-serialize', function(event,form,options,veto){#}
                {#    	tinyMCE.triggerSave();#}
                {#{);#}
                {#                var data = $("#commentForm").serialize();#}



                // bind form using 'ajaxForm'
                $('#commentForm').ajaxForm();
                // 绑定form-pre-serialize事件，在触发form-serilaize事件前保存tinyMCE的数据到textarea中
                $('#commentForm').bind('form-pre-serialize', function (event, form, options, veto) {
                    tinyMCE.triggerSave();
                });
                $("#commentForm").ajaxSubmit({
                    type: 'post',
                    url: tagUrl,
                    cache: false,
                    {#data: data,#}
                    dataType: 'json',
                    success: function (data) {
                        {#alert('success');#}
                        var datas = eval(data);
                        var html = ""
                        if (datas.comment_status == '2'){
                            html = '<div class="itemdiv commentdiv">\n' +
                            '                                            <div class="user">\n' +
                            '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                            +
                            '                                                         src="' + datas.avatar + '"/>\n'
                            +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="body">\n' +
                            '                                                <div class="name">\n' +
                            '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                            '                                                </div>\n' +

                            '\n' +
                            '                                                <div class="time">\n' +
                            '                                                    <i class="icon-time"></i>\n' +
                                '<span class="red">待审核</span>' +
                            '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="text">\n' +
                            '<div class="space"></div>\n' +

                            '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                            '                                                    ' + datas.comment + '\n' +
                            '<div class="space"></div>\n' +
                            '\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="tools">\n' +
                            '                                                <div class="action-buttons bigger-125">\n' +
                            '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                            '                                                        <i class="icon-comments blue"></i>\n' +
                            '                                                    </a>\n' +
                            '\n' +
                                 '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '                                        </div>'
                        } else {
                            html = '<div class="itemdiv commentdiv">\n' +
                            '                                            <div class="user">\n' +
                            '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                            +
                            '                                                         src="' + datas.avatar + '"/>\n'
                            +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="body">\n' +
                            '                                                <div class="name">\n' +
                            '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="time">\n' +
                                 '   <a href="javascript:void(0);" id="'+ datas.id +'" class="likecomment"> <i class="icon-thumbs-up-alt"></i></a>'+
                                                   ' <span id="like_comment_count">0</span>'+
                            '                                                    <i class="icon-time"></i>\n' +
                            '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="text">\n' +
                            '<div class="space"></div>\n' +

                            '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                            '                                                    ' + datas.comment + '\n' +
                            '<div class="space"></div>\n' +
                            '\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="tools">\n' +
                            '                                                <div class="action-buttons bigger-125">\n' +
                            '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                            '                                                        <i class="icon-comments blue"></i>\n' +
                            '                                                    </a>\n' +
                            '\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '                                        </div>'
                            $("span#comment_count").text(datas.comment_count)
                        }
                        $("#comments").prepend(html)
                        tinymce.activeEditor.setContent("");
                        tinymce.activeEditor.focus();
                        {#tinymce.setActive()#}
                        {#$("#commentForm").focus()#}
                    },

                    error: function (data) {
                        alert("请求失败--" + data)
                    }

                })
            });

            $("div#comment-tab").on('click', '#subcomm2', function () {
                var tagUrl = $("#commentForm").attr("action");
                {#                var veto = {};#}
                {##}
                {#                $('#commentForm').ajaxForm();#}
                {#                $('#commentForm').bind('form-pre-serialize', function(event,form,options,veto){#}
                {#    	tinyMCE.triggerSave();#}
                {#{);#}
                {#                var data = $("#commentForm").serialize();#}



                // bind form using 'ajaxForm'
                $('#commentForm').ajaxForm();
                // 绑定form-pre-serialize事件，在触发form-serilaize事件前保存tinyMCE的数据到textarea中
                $('#commentForm').bind('form-pre-serialize', function (event, form, options, veto) {
                    tinyMCE.triggerSave();
                });
                $("#commentForm").ajaxSubmit({
                    type: 'post',
                    url: tagUrl,
                    cache: false,
                    {#data: data,#}
                    dataType: 'json',
                    success: function (data) {
                        {#alert('success');#}
                        var datas = eval(data);
                        var html = ""
                        if (datas.comment_status == '2') {
                            html = '<div class="itemdiv commentdiv">\n' +
                                '                                            <div class="user">\n' +
                                '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                                +
                                '                                                         src="' + datas.avatar + '"/>\n'
                                +
                                '                                            </div>\n' +
                                '\n' +
                                '                                            <div class="body">\n' +
                                '                                                <div class="name">\n' +
                                '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                                '                                                </div>\n' +

                                '\n' +
                                '                                                <div class="time">\n' +
                                '                                                    <i class="icon-time"></i>\n' +
                                '<span class="red">待审核</span>' +
                                '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                                '                                                </div>\n' +
                                '\n' +
                                '                                                <div class="text">\n' +
                                '<div class="space"></div>\n' +

                                '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                                '                                                    ' + datas.comment + '\n' +
                                '<div class="space"></div>\n' +
                                '\n' +
                                '                                                </div>\n' +
                                '                                            </div>\n' +
                                '\n' +
                                '                                            <div class="tools">\n' +
                                '                                                <div class="action-buttons bigger-125">\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                                '                                                        <i class="icon-comments blue"></i>\n' +
                                '                                                    </a>\n' +
                                '\n' +
                                 '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                                '                                                </div>\n' +
                                '                                            </div>\n' +
                                '                                        </div>'
                        } else {
                            html = '<div class="itemdiv commentdiv">\n' +
                                '                                            <div class="user">\n' +
                                '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                                +
                                '                                                         src="' + datas.avatar + '"/>\n'
                                +
                                '                                            </div>\n' +
                                '\n' +
                                '                                            <div class="body">\n' +
                                '                                                <div class="name">\n' +
                                '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                                '                                                </div>\n' +
                                '\n' +
                                '                                                <div class="time">\n' +
                                    '   <a href="javascript:void(0);" id="'+ datas.id +'" class="likecomment"> <i class="icon-thumbs-up-alt"></i></a>'+
                                                   ' <span id="like_comment_count">0</span>'+
                                '                                                    <i class="icon-time"></i>\n' +
                                '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                                '                                                </div>\n' +
                                '\n' +
                                '                                                <div class="text">\n' +
                                '<div class="space"></div>\n' +

                                '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                                '                                                    ' + datas.comment + '\n' +
                                '<div class="space"></div>\n' +
                                '\n' +
                                '                                                </div>\n' +
                                '                                            </div>\n' +
                                '\n' +
                                '                                            <div class="tools">\n' +
                                '                                                <div class="action-buttons bigger-125">\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                                '                                                        <i class="icon-comments blue"></i>\n' +
                                '                                                    </a>\n' +
                                '\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                                '                                                </div>\n' +
                                '                                            </div>\n' +
                                '                                        </div>'
                            $("span#comment_count").text(datas.comment_count)
                        }
                        $("#comments").prepend(html)
                        tinymce.activeEditor.setContent("");
                        tinymce.activeEditor.focus();
                        {#tinymce.setActive()#}
                        {#$("#commentForm").focus()#}
                    },

                    error: function (data) {
                        alert("请求失败--" + data)
                    }

                })
            });

            $("div#comment-tab").on('click', '#submit', function () {
                var tagUrl = $("#commentForm").attr("action");
                {#                var veto = {};#}
                {##}
                {#                $('#commentForm').ajaxForm();#}
                {#                $('#commentForm').bind('form-pre-serialize', function(event,form,options,veto){#}
                {#    	tinyMCE.triggerSave();#}
                {#{);#}
                {#                var data = $("#commentForm").serialize();#}



                // bind form using 'ajaxForm'
                $('#commentForm').ajaxForm();
                // 绑定form-pre-serialize事件，在触发form-serilaize事件前保存tinyMCE的数据到textarea中
                $('#commentForm').bind('form-pre-serialize', function (event, form, options, veto) {
                    tinyMCE.triggerSave();
                });
                $("#commentForm").ajaxSubmit({
                    type: 'post',
                    url: tagUrl,
                    cache: false,
                    {#data: data,#}
                    dataType: 'json',
                    success: function (data) {
                        {#alert('success');#}
                        var datas = eval(data);
                        var html = "";
                        if (datas.comment_status == '2'){
                            html = '<div class="itemdiv commentdiv">\n' +
                            '                                            <div class="user">\n' +
                            '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                            +
                            '                                                         src="' + datas.avatar + '"/>\n'
                            +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="body">\n' +
                            '                                                <div class="name">\n' +
                            '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                            '                                                </div>\n' +


                            '\n' +
                            '                                                <div class="time">\n' +
                            '                                                    <i class="icon-time"></i>\n' +
                                '<span class="red">待审核</span>' +
                            '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="text">\n' +
                            '<div class="space"></div>\n' +

                                '                                                         <div class="commentquote">\n'
                                +
                                '                                                         <div class="name col-md-6 no-padding-left">\n'
                                +
                                '                                                            @' + datas.parent_author + '\n'
                                +
                                '                                                             </div>\n' +
                                '                                                             <div class="time col-md-6 text-right">\n'
                                +
                                '                                                                <i class="icon-time"></i>\n'
                                +
                                '                                                                <span class="blue">' + datas.parent_comment_date + '</span>\n'
                                +
                                '                                                            </div>\n' +
                                '                                                          <div class="text">\n' +
                                '                                                            <i class="icon-quote-left"></i>' + datas.parent_comment + '\n'
                                +
                                '                                                          </div>\n' +
                                '                                                         </div>\n' +
                                '                                                         <div class="space"></div>\n'
                                +

                            '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                            '                                                    ' + datas.comment + '\n' +
                            '<div class="space"></div>\n' +
                            '\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="tools">\n' +
                            '                                                <div class="action-buttons bigger-125">\n' +
                            '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                            '                                                        <i class="icon-comments blue"></i>\n' +
                            '                                                    </a>\n' +
                            '\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '                                        </div>'
                        } else {
                            html = '<div class="itemdiv commentdiv">\n' +
                            '                                            <div class="user">\n' +
                            '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                            +
                            '                                                         src="' + datas.avatar + '"/>\n'
                            +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="body">\n' +
                            '                                                <div class="name">\n' +
                            '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="time">\n' +
                                    '   <a href="javascript:void(0);" id="'+ datas.id +'" class="likecomment"> <i class="icon-thumbs-up-alt"></i></a>'+
                                                   ' <span id="like_comment_count">0</span>'+
                            '                                                    <i class="icon-time"></i>\n' +
                            '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="text">\n' +
                            '<div class="space"></div>\n' +

                                '                                                         <div class="commentquote">\n'
                                +
                                '                                                         <div class="name col-md-6 no-padding-left">\n'
                                +
                                '                                                            @' + datas.parent_author + '\n'
                                +
                                '                                                             </div>\n' +
                                '                                                             <div class="time col-md-6 text-right">\n'
                                +
                                '                                                                <i class="icon-time"></i>\n'
                                +
                                '                                                                <span class="blue">' + datas.parent_comment_date + '</span>\n'
                                +
                                '                                                            </div>\n' +
                                '                                                          <div class="text">\n' +
                                '                                                            <i class="icon-quote-left"></i>' + datas.parent_comment + '\n'
                                +
                                '                                                          </div>\n' +
                                '                                                         </div>\n' +
                                '                                                         <div class="space"></div>\n'
                                +

                            '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                            '                                                    ' + datas.comment + '\n' +
                            '<div class="space"></div>\n' +
                            '\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="tools">\n' +
                            '                                                <div class="action-buttons bigger-125">\n' +
                            '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment">\n' +
                            '                                                        <i class="icon-comments blue"></i>\n' +
                            '                                                    </a>\n' +
                            '\n' +
                                '                                                     <a href="javascript:void(0);" id="' + datas.id + '" class="comment_del">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '                                        </div>'
                            $("span#comment_count").text(datas.comment_count)
                        }
                        $("#comments").prepend(html)
                        tinymce.activeEditor.setContent("")
                        tinymce.activeEditor.focus()
                        {#tinymce.setActive()#}
                        {#$("#commentForm").focus()#}
                    },

                    error: function (data) {
                        alert("请求失败--" + data)
                    }

                })
            });

            $("div#comment-tab").on("click", "a.comment_del", function () {

                var comment_id = $(this).attr("id")
                var obj = $(this)
                var div = obj.parents('div.commentdiv')
                var url = "{% url 'comment_del' 123 %}"
                url = url.replace('123', comment_id)

                $.ajax({
                    type: "GET",
                    url: url,
                    datatype: 'json',
                    success: function (result) {
                        if (result.result == 'success') {
                            alert(result.msg);
                             tinymce.remove();
                            $("textarea").remove();
                            $("form").remove();
                            $("#divcomment").remove();
                            div.remove();
                            html = "<div  id='divcomment'>\n" +
                                "                                    <div class=\"center\">\n" +
                                "                                        <i class=\"icon-comments-alt icon-2x green\"></i>\n" +
                                "\n" +
                                "                                        &nbsp;<label class=\"control-label no-padding-left\"\n" +
                                "                                                     for=\"form-field-textarea\">发表评论</label>\n" +
                                "                                    </div>\n" +
                                "\n" +
                                "                                    <form class=\"form-horizontal\" role=\"form\" id=\"commentForm\"\n" +
                                "                                          action=\"{% url 'comment' %}\"\n" +
                                "                                          method=\"post\">\n" +
                                "                                        {% csrf_token %}\n" +
                                "                                        {% if not request.session.user %}\n"+
                                    "                                            <div class=\"form-group\">\n"+
                                    "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                                    +
                                    "                                                       for=\"form-field-1\"> 姓名：</label>\n"+
                                    "\n"+
                                    "                                                <div class=\"col-sm-10\">\n"+
                                    "                                                    <input type=\"text\" id=\"form-field-1\" name=\"comment_author\"\n"
                                    +
                                    "                                                           placeholder=\"comment_author\"\n"+
                                    "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                                    +
                                    "                                                </div>\n"+
                                    "                                            </div>\n"+
                                    "                                            <div class=\"form-group\">\n"+
                                    "                                                <label class=\"col-sm-2 control-label no-padding-left\"\n"
                                    +
                                    "                                                       for=\"form-field-2\"> 邮箱：</label>\n"+
                                    "\n"+
                                    "                                                <div class=\"col-sm-10\">\n"+
                                    "                                                    <input type=\"text\" id=\"form-field-2\" name=\"comment_author_email\"\n"
                                    +
                                    "                                                           placeholder=\"comment_author_email\"\n"
                                    +
                                    "                                                           class=\"col-xs-10 col-sm-5 align-left\"/>\n"
                                    +
                                    "                                                </div>\n"+
                                    "                                            </div>\n"+
                                    "                                        {% else %}\n"+
                                    "                                            <input type=\"hidden\" name=\"user\" value=\"{{ request.session.user.pk }}\">\n"
                                    +
                                    "                                            <input type=\"hidden\" name=\"comment_author\"\n"+
                                    "                                                   value=\"{{ request.session.user.username }}\">\n"
                                    +
                                    "                                            <input type=\"hidden\" name=\"comment_author_email\"\n"
                                    +
                                    "                                                   value=\"{{ request.session.user.email }}\">\n"
                                    +
                                    "                                        {% endif %}\n" +
                                "                                        <textarea id=\"form-field-textarea\" name=\"comment\" class=\"form-control\" rows=\"5\"\n" +
                                "                                                  value=\"\"></textarea>\n" +
                                "                                        <input type=\"hidden\" name=\"article\" value=\"{{ post.pk }}\">\n" +

                                "                                        <input type=\"hidden\" name=\"comment_author_ip\" value=\"\n" +
                                "                                    {% if not request.META.HTTP_X_FORWARDED_FOR %}\n"+
                                    "                                        {{ request.META.REMOTE_ADDR }}\n"+
                                    "                                    {% else %}\n"+
                                    "                                        {{ request.META.HTTP_X_FORWARDED_FOR }}\n"+
                                    "                                    {% endif %}\n" +
                                "                                    \">\n" +
                                "\n" +
                                "                                        <div class=\"space\"></div>\n" +
                                "                                        <div class=\"form-group\" id=\"submitcomment\">\n" +
                                "                                            <button class=\"btn btn-sm btn-danger\" type=\"button\" id=\"subcomm2\">\n" +
                                "                                                <i class=\"icon-ok bigger-110\"></i>\n" +
                                "                                                发表评论\n" +
                                "                                            </button>\n" +

                                "                                        </div>\n" +
                                "                                    </form>\n" +
                                "\n" +
                                "                                    <div class=\"space\"></div>\n" +
                                "\n" +
                                "                                </div>";
                            obj = $('div#commenthr')

                            obj.after(html);
                            tinymce.init({
                                selector: "textarea",
                                {#width: 800,#}
                                height: 100,
                                forced_root_block: false,
                                convert_urls: false,
                                {#            imageupload_url: '{% url 'upload' %}',#}
                                plugins: ["save"],
                                toolbar: "save styleselect | bold italic | alignleft aligncenter" +
                                " alignright alignjustify | bullist numlist outdent indent |  link image"
                            });

                            $('span#comment_count').text(result.comment_count)
                        } else {
                            if(!result.result)
                                alert("非注册用户不能自行删除评论")
                            else {
                                alert(result.msg)
                            }
                        }
                    },
                    error: function () {
                        alert('异常')
                    }
                })
            })

            $(".likearticle").click(function () {
                var islogin = null
                {% if request.session.user.pk %}
                    islogin = {{ request.session.user.pk }}
                {% endif %}
                if (!islogin) {
                    alert("未登录！")
                    return;
                }
                var url = "{% url 'like_article' post.pk  123 %}"
                url = url.replace(123, islogin)
                obj = $(this).children("i")
                spanobj = $(this).next('span#like_count')
                count = Number(spanobj.text())
                $.ajax({
                    type: "GET",
                    url: url,
                    datatype: 'json',
                    success: function (result) {
                        if (result.result == 'success') {

                            if (obj.attr("class") == "icon-heart-empty") {
                                obj.removeClass("icon-heart-empty")
                                obj.addClass("icon-heart red")

                                spanobj.text(count + 1)

                            } else {
                                obj.removeClass("icon-heart red")
                                obj.addClass("icon-heart-empty")
                                spanobj.text(count - 1)
                            }
                        }
                    }
                })
            })

         $("div#comment-tab").on("click", ".likecomment", function () {
                var islogin = null
                {% if request.session.user.pk %}
                    islogin = {{ request.session.user.pk }}
                {% endif %}
                if (!islogin) {
                    alert("未登录！")
                    return;
                }
                var comment_id = $(this).attr("id")
                var url = "{% url 'like_comment' 456  123 %}"
                url = url.replace(123, islogin)
                url = url.replace(456, comment_id)
                obj = $(this).children("i")
                spanobj = $(this).next('span#like_comment_count')
                count = Number(spanobj.text())
                $.ajax({
                    type: "GET",
                    url: url,
                    datatype: 'json',
                    success: function (result) {
                        if (result.result == 'success') {

                            if (obj.attr("class") == "icon-thumbs-up-alt") {
                                obj.removeClass("icon-thumbs-up-alt")
                                obj.addClass("icon-thumbs-up red")

                                spanobj.text(count + 1)

                            } else {
                                obj.removeClass("icon-thumbs-up red")
                                obj.addClass("icon-thumbs-up-alt")
                                spanobj.text(count - 1)
                            }
                        }
                    }
                })
            })


        });
    </script>
{% endblock %}
