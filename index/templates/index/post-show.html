{% extends 'index/base.html' %}
{% load staticfiles %}
{% load static %}
{% block header %}
    <link rel="stylesheet" href="/static/assets/css/ace.min.front.css"/>

    <script type="text/javascript" src="{% static 'tinymce/tinymce.min.js' %}"></script>
    {#    <script type="text/javascript">#}
    {#        tinymce.init({#}
    {#            selector: "textarea",#}
            {#width: 800,#}
    {#            height: 300,#}
    {#            forced_root_block: false,#}
    {#            convert_urls: false,#}
            {#            imageupload_url: '{% url 'upload' %}',#}
    {#            plugins: [],#}
    {#            toolbar: "styleselect | bold italic | alignleft aligncenter" +#}
    {#            " alignright alignjustify | bullist numlist outdent indent |  link image"#}
    {#        });#}
    {#    </script>#}
    <script type="text/javascript" src="{% static 'tinymce/plugins/jquery-form.js' %}"></script>
    <script type="text/javascript">
        $.ajaxSetup({headers: {"X-CSRFToken": '{{ csrf_token }}'}});
    </script>
{% endblock %}

{% block page %}
    <div class="col-md-8 ">
        <div class="blog-post">
            <h1>{{ post.title }}.</h1>
            <h4><i class="icon-user"></i> <a href="#">{{ post.pub_author }}</a> <i
                    class="icon-calendar"></i> {{ post.pub_date }}
                <i class="icon-folder-open"></i> <a href="#"> {% if post.category is None %}未归档{% else %}
                    {{ post.category }}{% endif %}</a>
                <i class="icon-eye-open"></i> {{ post.view_count }} views</h4>

            <p style=word-wrap:break-word;>
                {{ post.content|safe }}
            </p>
            <h3><i class="icon-tags"></i> ：{% for tag in post.tag_set.all %}
                <label class="label-info label-lg label">{{ tag }}</label>
            {% endfor %}
            </h3>
            <div class="col-md-6 text-left">
                {% if pre_post %}
                    <a href="{{ pre_post.guid }}">
                        <span aria-hidden="true"><< {{ pre_post }}</span>
                    </a>
                {% endif %}
            </div>


            <div class="col-md-6 text-right">
                {% if next_post %}
                    <a href="{{ next_post.guid }}">
                        <span aria-hidden="true">{{ next_post }} >></span>
                    </a>
                {% endif %}
            </div>

        </div>
        <div class="space"></div>


        {#        <div class="col-md-12 blog-post">#}
        {#            <div class="col-md-6 text-left align-center">#}
        {#                {% if pre_post %}#}
        {#                    <a href="{{ pre_post.guid }}">#}
        {#                        <span aria-hidden="true"><< {{ pre_post }}</span>#}
        {#                    </a>#}
        {#                {% endif %}#}
        {#            </div>#}
        {##}
        {##}
        {#            <div class="col-md-6 text-right align-center">#}
        {#                {% if next_post %}#}
        {#                    <a href="{{ next_post.guid }}">#}
        {#                        <span aria-hidden="true">{{ next_post }} >></span>#}
        {#                    </a>#}
        {#                {% endif %}#}
        {#            </div>#}
        {##}
        {#        </div>#}


        <div class="col-md-12">
            <div class="widget-box transparent" id="recent-box">
                <div class="widget-header">
                    <h4 class="lighter smaller">
                        <i class="icon-rss orange"></i>
                        最近
                    </h4>

                    <div class="widget-toolbar no-border">
                        <ul class="nav nav-tabs" id="recent-tab">


                            <li class="active">
                                <a data-toggle="tab" href="#comment-tab">评论</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="widget-body">
                    <div class="widget-main padding-4">
                        <div class="tab-content padding-8 overflow-visible">


                            <div id="comment-tab" class="tab-pane active">

                                <div class="comments" id="comments">

                                    {% for comment in comments %}
                                        <div class="itemdiv commentdiv">
                                            <div class="user">
                                                {% if comment.user %}
                                                    <img alt="{{ comment.comment_author }}'s Avatar"
                                                         src="{{ comment.user.avatar }}"/>
                                                {% else %}
                                                    <img alt="{{ comment.comment_author }}'s Avatar"
                                                         src="/static/assets/avatars/avatar.png"/>
                                                {% endif %}
                                            </div>

                                            <div class="body">
                                                <div class="name">
                                                    <a href="#">{{ comment.comment_author }}</a>
                                                </div>

                                                <div class="time">
                                                    <i class="icon-time"></i>
                                                    <span class="blue">{{ comment.comment_date }}</span>
                                                </div>

                                                <div class="text">
                                                    <div class="space"></div>
                                                    {#                                                <i class="icon-quote-left"></i>#}
                                                    {{ comment.comment|safe }}
                                                    <div class="space"></div>
                                                </div>


                                            </div>
                                            <div class="tools">
                                                <div class="action-buttons bigger-125">
                                                    <button id="{{ comment.pk }}" class="comment">
                                                        <i class="icon-comments blue"></i>
                                                    </button>

                                                    <a href="#">
                                                        <i class="icon-trash red"></i>
                                                    </a>
                                                </div>

                                            </div>


                                        </div>
                                    {% endfor %}

                                </div>

                                <div class="hr hr8"></div>

                                <div class="col-md-12">
                                    <div class="center">
                                        <i class="icon-comments-alt icon-2x green"></i>

                                        &nbsp;<label class="control-label no-padding-left"
                                                     for="form-field-textarea">发表评论</label>
                                    </div>

                                    <form class="form-horizontal" role="form" id="commentForm"
                                          action="{% url 'comment' %}"
                                          method="post">
                                        {% csrf_token %}
                                        {% if not request.session.user %}
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right"
                                                       for="form-field-1"> 姓名：</label>

                                                <div class="col-sm-11">
                                                    <input type="text" id="form-field-1" name="comment_author"
                                                           placeholder="comment_author"
                                                           class="col-xs-10 col-sm-5 align-left"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right"
                                                       for="form-field-2"> 邮箱：</label>

                                                <div class="col-sm-11">
                                                    <input type="text" id="form-field-2" name="comment_author_email"
                                                           placeholder="comment_author_email"
                                                           class="col-xs-10 col-sm-5 align-left"/>
                                                </div>
                                            </div>
                                        {% else %}
                                            <input type="hidden" name="user" value="{{ request.session.user.pk }}">
                                            <input type="hidden" name="comment_author"
                                                   value="{{ request.session.user.username }}">
                                            <input type="hidden" name="comment_author_email"
                                                   value="{{ request.session.user.email }}">
                                        {% endif %}
                                        <textarea id="form-field-textarea" name="comment" class="form-control" rows="5"
                                                  value=""></textarea>
                                        <input type="hidden" name="article" value="{{ post.pk }}">
                                        <input type="hidden" name="comment_author_ip" value="
                                    {% if not request.META.HTTP_X_FORWARDED_FOR %}
                                        {{ request.META.REMOTE_ADDR }}
                                    {% else %}
                                        {{ request.META.HTTP_X_FORWARDED_FOR }}
                                    {% endif %}
                                    ">

                                        <div class="space"></div>
                                        <div class="form-group">
                                            <button class="btn btn-sm btn-danger" type="button" id="submit">
                                                <i class="icon-ok bigger-110"></i>
                                                发表评论
                                            </button>
                                        </div>
                                    </form>

                                    <div class="space"></div>

                                </div>

                                <div class="hr hr-double hr8"></div>
                            </div>
                        </div>
                    </div><!-- /widget-main -->
                </div><!-- /widget-body -->

            </div><!-- /widget-box -->
        </div><!-- /span -->
    </div>
    <div class="col-md-1"></div>
    {#    <script type="text/javascript" src="{% static 'tinymce/plugins/jquery-form.js' %}"></script>#}

    <script
            type="text/javascript">
        $(document).ready(function () {
            $("#form-field-textarea").click(function () {
                tinymce.init({
                    selector: "textarea",
                    {#width: 800,#}
                    height: 100,
                    forced_root_block: false,
                    convert_urls: false,
                    {#            imageupload_url: '{% url 'upload' %}',#}
                    plugins: [],
                    toolbar: "styleselect | bold italic | alignleft aligncenter" +
                    " alignright alignjustify | bullist numlist outdent indent |  link image"
                });

            })

            $(".comment").click(function () {
                obj = $(this).parent().parent().prev().children('div.text');
                alert(obj.prop("class"));
                $("textarea").remove();
                obj.append("<textarea id=\"form-field-textarea\" name=\"comment\" class=\"form-control\" rows=\"5\" value=\"\"></textarea>");
                tinymce.init({
                    selector: "textarea",
                    {#width: 800,#}
                    height: 100,
                    forced_root_block: false,
                    convert_urls: false,
                    {#            imageupload_url: '{% url 'upload' %}',#}
                    plugins: ["save"],
                    toolbar: "save styleselect | bold italic | alignleft aligncenter" +
                    " alignright alignjustify | bullist numlist outdent indent |  link image"
                });
            })

            $("#submit").click(function () {
                var tagUrl = $("#commentForm").attr("action");
                {#                var veto = {};#}
                {##}
                {#                $('#commentForm').ajaxForm();#}
                {#                $('#commentForm').bind('form-pre-serialize', function(event,form,options,veto){#}
                {#    	tinyMCE.triggerSave();#}
                {#{);#}
                {#                var data = $("#commentForm").serialize();#}



                // bind form using 'ajaxForm'
                $('#commentForm').ajaxForm();
                // 绑定form-pre-serialize事件，在触发form-serilaize事件前保存tinyMCE的数据到textarea中
                $('#commentForm').bind('form-pre-serialize', function (event, form, options, veto) {
                    tinyMCE.triggerSave();
                });
                $("#commentForm").ajaxSubmit({
                    type: 'post',
                    url: tagUrl,
                    cache: false,
                    {#data: data,#}
                    dataType: 'json',
                    success: function (data) {
                        {#alert('success');#}
                        var datas = eval(data);
                        $("#comments").prepend('<div class="itemdiv commentdiv">\n' +
                            '                                            <div class="user">\n' +
                            '                                                    <img alt="' + datas.comment_author + '\'s Avatar"\n'
                            +
                            '                                                         src="' + datas.avatar + '"/>\n'
                            +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="body">\n' +
                            '                                                <div class="name">\n' +
                            '                                                    <a href="#">' + datas.comment_author + '</a>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="time">\n' +
                            '                                                    <i class="icon-time"></i>\n' +
                            '                                                    <span class="blue">' + datas.comment_date + '</span>\n' +
                            '                                                </div>\n' +
                            '\n' +
                            '                                                <div class="text">\n' +
                            '                                                    {#                                                <i class="icon-quote-left"></i>#}\n' +
                            '                                                    ' + datas.comment + '\n' +
                            '\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '\n' +
                            '                                            <div class="tools">\n' +
                            '                                                <div class="action-buttons bigger-125">\n' +
                            '                                                    <a href="#">\n' +
                            '                                                        <i class="icon-pencil blue"></i>\n' +
                            '                                                    </a>\n' +
                            '\n' +
                            '                                                    <a href="#">\n' +
                            '                                                        <i class="icon-trash red"></i>\n' +
                            '                                                    </a>\n' +
                            '                                                </div>\n' +
                            '                                            </div>\n' +
                            '                                        </div>')
                        tinymce.activeEditor.setContent("")
                        tinymce.activeEditor.focus()
                        {#tinymce.setActive()#}
                        {#$("#commentForm").focus()#}
                    },

                    error: function () {
                        alert("请求失败")
                    }

                })
            });
        });
    </script>
{% endblock %}
